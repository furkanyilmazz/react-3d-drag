"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("@babel/runtime/helpers/objectWithoutPropertiesLoose"),r=require("react"),n=require("three"),i=require("@react-three/fiber"),a=require("react-merge-refs"),o=require("../materials/MeshReflectorMaterial.cjs.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("@babel/runtime/helpers/createClass"),require("@babel/runtime/helpers/inheritsLoose");var l=u(e),c=u(t),d=s(r),m=u(a);i.extend({MeshReflectorMaterial:o.MeshReflectorMaterial});var f=d.forwardRef((function(e,t){var r=e.mixBlur,a=void 0===r?0:r,o=e.mixStrength,u=void 0===o?.5:o,s=e.resolution,f=void 0===s?256:s,p=e.args,h=void 0===p?[1,1]:p,x=e.minDepthThreshold,M=void 0===x?.9:x,g=e.maxDepthThreshold,b=void 0===g?1:g,v=e.depthScale,T=void 0===v?0:v,S=e.depthToBlurRatioBias,w=void 0===S?.25:S,y=e.mirror,R=e.children,j=e.debug,F=void 0===j?0:j,B=e.distortion,D=void 0===B?1:B,W=e.distortionMap,V=c.default(e,["mixBlur","mixStrength","resolution","args","minDepthThreshold","maxDepthThreshold","depthScale","depthToBlurRatioBias","mirror","children","debug","distortion","distortionMap"]),_=i.useThree((function(e){return e.gl})),E=i.useThree((function(e){return e.camera})),P=i.useThree((function(e){return e.scene})),q=d.useRef(null),O=d.useState((function(){return new n.Plane}))[0],L=d.useState((function(){return new n.Vector3}))[0],k=d.useState((function(){return new n.Vector3}))[0],G=d.useState((function(){return new n.Vector3}))[0],z=d.useState((function(){return new n.Matrix4}))[0],C=d.useState((function(){return new n.Vector3(0,0,-1)}))[0],I=d.useState((function(){return new n.Vector4}))[0],U=d.useState((function(){return new n.Vector3}))[0],A=d.useState((function(){return new n.Vector3}))[0],N=d.useState((function(){return new n.Vector4}))[0],H=d.useState((function(){return new n.Matrix4}))[0],J=d.useState((function(){return new n.PerspectiveCamera}))[0],K=d.useState((function(){for(var e=[],t={minFilter:n.LinearFilter,magFilter:n.LinearFilter,format:n.RGBFormat,encoding:_.outputEncoding},r=0;r<8;r++){var i=Math.max(8,Math.round(f/Math.pow(2,r))),a=new n.WebGLRenderTarget(i,i,t);a.texture.generateMipmaps=!1,e.push(a)}return e}))[0],Q=d.useCallback((function(){if(k.setFromMatrixPosition(q.current.matrixWorld),G.setFromMatrixPosition(E.matrixWorld),z.extractRotation(q.current.matrixWorld),L.set(0,0,1),L.applyMatrix4(z),U.subVectors(k,G),!(U.dot(L)>0)){U.reflect(L).negate(),U.add(k),z.extractRotation(E.matrixWorld),C.set(0,0,-1),C.applyMatrix4(z),C.add(G),A.subVectors(k,C),A.reflect(L).negate(),A.add(k),J.position.copy(U),J.up.set(0,1,0),J.up.applyMatrix4(z),J.up.reflect(L),J.lookAt(A),J.far=E.far,J.updateMatrixWorld(),J.projectionMatrix.copy(E.projectionMatrix),H.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),H.multiply(J.projectionMatrix),H.multiply(J.matrixWorldInverse),H.multiply(q.current.matrixWorld),O.setFromNormalAndCoplanarPoint(L,k),O.applyMatrix4(J.matrixWorldInverse),I.set(O.normal.x,O.normal.y,O.normal.z,O.constant);var e=J.projectionMatrix;N.x=(Math.sign(I.x)+e.elements[8])/e.elements[0],N.y=(Math.sign(I.y)+e.elements[9])/e.elements[5],N.z=-1,N.w=(1+e.elements[10])/e.elements[14],I.multiplyScalar(2/I.dot(N)),e.elements[2]=I.x,e.elements[6]=I.y,e.elements[10]=I.z+1,e.elements[14]=I.w}}),[E.far,E.matrixWorld,E.projectionMatrix,G,I,C,L,N,O,k,z,A,H,U,J]),X=d.useMemo((function(){var e={minFilter:n.LinearFilter,magFilter:n.LinearFilter,format:n.RGBFormat,encoding:_.outputEncoding},t=new n.WebGLRenderTarget(f,f,e);T>0&&(t.depthBuffer=!0,t.depthTexture=new n.DepthTexture(f,f),t.depthTexture.format=n.DepthFormat,t.depthTexture.type=n.UnsignedShortType);var r=K.reduce((function(e,t,r){return e["u_mipmap_"+r]=t.texture,e["u_mipmap_res_"+r]=new n.Vector2(t.width,t.height),e}),{});return[t,l.default({mirror:y,textureMatrix:H,mixBlur:a,tDiffuse:t.texture,tDepth:t.depthTexture,mixStrength:u,minDepthThreshold:M,maxDepthThreshold:b,depthScale:T,depthToBlurRatioBias:w,debug:F,distortion:D,distortionMap:W,"defines-USE_DEPTH":T>0?"":void 0,"defines-USE_DISTORTION":W?"":void 0},r)]}),[_,H,f,y,a,u,M,b,T,w,F,D,W,K]),Y=X[0],Z=X[1];return i.useFrame((function(){null!=q&&q.current&&(q.current.visible=!1,Q(),_.setRenderTarget(Y),_.state.buffers.depth.setMask(!0),_.render(P,J),0!==a&&K.forEach((function(e){_.setRenderTarget(e),_.state.buffers.depth.setMask(!0),_.render(P,J)})),q.current.visible=!0,_.setRenderTarget(null))})),d.createElement("mesh",l.default({ref:m.default([q,t])},V),d.createElement("planeBufferGeometry",{args:h}),R?R("meshReflectorMaterial",Z):d.createElement("meshReflectorMaterial",Z))}));exports.Reflector=f;
